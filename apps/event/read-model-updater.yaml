apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: read-model-updater-trigger-auth-aws-credentials
spec:
  secretTargetRef:
    - parameter: awsAccessKeyID
      name: secret-aws-credentials
      key: AWS_ACCESS_KEY_ID
    - parameter: awsSecretAccessKey
      name: secret-aws-credentials
      key: AWS_SECRET_ACCESS_KEY
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: read-model-updater-scaledobject
spec:
  scaleTargetRef:
    name: read-model-updater
  maxReplicaCount: 1
  triggers:
    - type: aws-dynamodb-streams
      authenticationRef:
        name: read-model-updater-trigger-auth-aws-credentials
      metadata:
        awsRegion: ap-northeast-1
        tableName: blogging_events-prod
        shardCount: "100"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: read-model-updater
  name: read-model-updater
spec:
  replicas: 0
  selector:
    matchLabels:
      app: read-model-updater
  template:
    metadata:
      labels:
        app: read-model-updater
    spec:
      containers:
        - name: read-model-updater
          image: ghcr.io/miyamo2/blogapi.miyamo.today:read-model-updater-d7c328583e6774dc32691cab4c096ff33fad8dcd
          imagePullPolicy: Always
          envFrom:
            - secretRef:
                name: secret-read-model-updater
            - secretRef:
                name: secret-aws-credentials
